{% extends "shop/base.html" %}
{% load static %}

{% block title %}{{ product.name }} - Rian Audio Sounds{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-5">
    
    <!-- Product Images -->
    <div class="col-12 col-md-6">
      <div class="product-card p-3 text-center">
        <img id="main-image"
             src="{{ product.main_image.url }}"
             alt="{{ product.name }}"
             class="img-fluid rounded shadow-sm w-100"
             style="object-fit: cover; max-height: 400px;">
      </div>

      {% if product.images.all %}
      <div class="d-flex flex-nowrap gap-2 mt-3 overflow-auto pb-2">
        <!-- Main Image Thumbnail -->
        <img src="{{ product.main_image.url }}" alt="Main thumbnail"
             class="img-thumbnail shadow-sm active-thumb"
             style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
             onclick="setMainImage(this)">
        
        <!-- Gallery Thumbnails -->
        {% for image in product.images.all %}
          <img src="{{ image.image.url }}" alt="thumbnail"
               class="img-thumbnail shadow-sm"
               style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
               onclick="setMainImage(this)">
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Product Info -->
    <div class="col-12 col-md-6">
      <div class="product-card p-4">
        <h1 class="h4 fw-bold mb-2 text-purple">{{ product.name }}</h1>
        <p class="text-muted small mb-2">{{ product.category.name }}</p>
        <p class="product-price mb-4 text-gold fw-semibold fs-5">
          KES {{ product.price }}
          {% if product.old_price %}
            <span class="text-muted text-decoration-line-through ms-2">
              KES {{ product.old_price }}
            </span>
          {% endif %}
        </p>

        <p class="mb-4">{{ product.description }}</p>

        <!-- ✅ Add to Cart Form -->
        <form method="post" action="{% url 'add_to_cart' product.id %}" class="d-flex align-items-center gap-3">
          {% csrf_token %}
          <input 
            id="quantity"
            name="quantity"
            type="number"
            value="1"
            min="1"
            class="form-control text-center border-purple fw-semibold"
            style="width: 90px;">
          
          <button type="submit"
                  class="btn btn-shop px-4 fw-semibold d-flex align-items-center gap-2">
            <i class="bi bi-cart-plus"></i> Add to Cart
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Reviews -->
  <section class="mt-5">
    <h2 class="h5 fw-bold mb-4 text-purple">Customer Reviews</h2>
    <div class="vstack gap-3" id="reviews-section">
      {% include "components/reviews.html" with reviews=reviews %}
    </div>

    <!-- Review Form -->
    {% if user.is_authenticated %}
    <div class="product-card mt-4 p-4">
      <h5 class="fw-semibold mb-3 text-purple">Leave a Review</h5>
      <form id="review-form">
        {% csrf_token %}
        <div class="mb-3">
          <textarea name="comment" rows="4" placeholder="Write your review..."
                    class="form-control" required></textarea>
        </div>
        <div class="mb-3 d-flex align-items-center gap-2">
          <label class="form-label mb-0 text-purple">Rating:</label>
          <select name="rating" class="form-select w-auto">
            <option value="5">⭐⭐⭐⭐⭐</option>
            <option value="4">⭐⭐⭐⭐</option>
            <option value="3">⭐⭐⭐</option>
            <option value="2">⭐⭐</option>
            <option value="1">⭐</option>
          </select>
        </div>
        <button type="submit" class="btn btn-shop">Submit Review</button>
      </form>
    </div>
    {% else %}
      <p class="mt-3 text-muted">
        Please <a href="{% url 'login' %}" class="text-gold fw-semibold">login</a> to leave a review.
      </p>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
function setMainImage(thumb) {
  const mainImg = document.getElementById("main-image");
  mainImg.src = thumb.src;
  document.querySelectorAll(".img-thumbnail").forEach(el => el.classList.remove("active-thumb"));
  thumb.classList.add("active-thumb");
}
</script>

<style>
.active-thumb { border: 2px solid #6f42c1; }
.border-purple { border: 2px solid #6f42c1 !important; }
.btn-shop {
  background: #6f42c1; color: #fff; border-radius: 8px; transition: 0.3s;
}
.btn-shop:hover { background: #FFD700; color: #000; }
</style>
{% endblock %}
